#!/usr/bin/env python
from argparse import ArgumentParser, REMAINDER
from functools import partial
from imp import load_dynamic
import logging
from mutagen.mp3 import MP3
from mutagen.id3 import TALB, TIT2, TPE1, TPE2
from os import listdir
import re
from sys import argv
from tempfile import *

logging.basicConfig(level=logging.DEBUG, format='%(asctime)-15s %(message)s')
logger = logging.getLogger(__name__)

cconvso = "".join(map(chr, map(partial(int, base=16), re.findall("..", '''
cffaedfe0700000103000000080000000f000000b8050000850000000000
000019000000280200005f5f544558540000000000000000000000000000
000000000010000000000000000000000000000000100000000000000700
00000500000006000000000000005f5f7465787400000000000000000000
5f5f5445585400000000000000000000700c000000000000720100000000
0000700c0000040000000000000000000000000400800000000000000000
000000005f5f73747562730000000000000000005f5f5445585400000000
000000000000e20d0000000000005400000000000000e20d000001000000
0000000000000000080400800000000006000000000000005f5f73747562
5f68656c7065720000005f5f5445585400000000000000000000380e0000
000000009c00000000000000380e00000200000000000000000000000004
00800000000000000000000000005f5f63737472696e6700000000000000
5f5f5445585400000000000000000000d40e000000000000670000000000
0000d40e0000000000000000000000000000020000000000000000000000
000000005f5f756e77696e645f696e666f0000005f5f5445585400000000
0000000000003b0f00000000000050000000000000003b0f000000000000
0000000000000000000000000000000000000000000000005f5f65685f66
72616d650000000000005f5f5445585400000000000000000000900f0000
000000006800000000000000900f00000300000000000000000000000000
000000000000000000000000000019000000880100005f5f444154410000
000000000000000000100000000000000010000000000000001000000000
00000010000000000000070000000300000004000000000000005f5f6e6c
5f73796d626f6c5f707472005f5f44415441000000000000000000000010
000000000000100000000000000000100000030000000000000000000000
060000000e00000000000000000000005f5f676f74000000000000000000
00005f5f4441544100000000000000000000101000000000000010000000
000000001010000003000000000000000000000006000000100000000000
0000000000005f5f6c615f73796d626f6c5f707472005f5f444154410000
000000000000000020100000000000007000000000000000201000000300
00000000000000000000070000001200000000000000000000005f5f6461
7461000000000000000000005f5f44415441000000000000000000009010
000000000000400000000000000090100000040000000000000000000000
0000000000000000000000000000000019000000480000005f5f4c494e4b
454449540000000000000020000000000000001000000000000000200000
000000005006000000000000070000000100000000000000000000002200
008030000000002000000800000008200000480000000000000000000000
502000000801000058210000280000000200000018000000002200002100
000090240000c00100000b00000050000000000000000e0000000e000000
020000001000000011000000000000000000000000000000000000000000
000000000000102400002000000000000000000000000000000000000000
1b000000180000003e4cc7d2e39c35919589b3e241d25b12240000001000
000000080a0000090a002a0000001000000000000000000000000c000000
38000000180000000200000000000700000007002f7573722f6c69622f6c
696269636f6e762e322e64796c6962000000000000000c00000050000000
180000000200000000000100000001002f55736572732f726f6265727473
6869682f686f6d65627265772f6c69622f6c696263636f6e762e302e302e
302e64796c696200000000000c0000003800000018000000020000000101
ad04000001002f7573722f6c69622f6c696253797374656d2e422e64796c
696200000000000026000000100000008021000008000000290000001000
000088210000000000002b00000010000000882100007800000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
00000000554889e541574156534883ec3848c745d00000000048c745c800
00000048c745c00000000048c745b8000000004c8d153002000031db488d
55e0488d4dd84c8d45d04c8d4dc031c04889f74c89d6e81f01000085c00f
84e7000000486b5dc00348895db84889dfe8180100004989c64d85f64c89
75c8745f4c89f74889dee825010000488b7dd8488b75e0e8120100004889
c34883fbff7448488d75d0488d55c0488d4dc84c8d45b84889dfe8e50000
004989c74889dfe8e00000004983ffff74414c89f7e8c00000004889c34c
89f7e8a9000000eb6be89c0000004889c3eb61488b05c0020000488b0848
8d3d77010000be20000000ba01000000e8b9000000eb35488b059e020000
488b18e89c0000008b38e8a70000004889c1488d356701000031c04889df
4889cae8840000004c89f7e846000000488b1d6102000048ff034889d848
83c4385b415e415f5dc3554889e5488d3d3a010000488d35be02000031d2
31c941b8f50300005de91e000000ff2538020000ff253a020000ff253c02
0000ff253e020000ff2540020000ff2542020000ff2544020000ff254602
0000ff2548020000ff254a020000ff254c020000ff254e020000ff255002
0000ff255202000000006800000000e9320000006818000000e928000000
682e000000e91e0000006840000000e9140000006854000000e90a000000
686f000000e9000000004c8d1d8d0100004153ff257d0100009068880000
00e9e6ffffff6895000000e9dcffffff68a8000000e9d2ffffff68ba0000
00e9c8ffffff68c9000000e9beffffff68d8000000e9b4ffffff68e70000
00e9aaffffff68f6000000e9a0ffffff73737323004e6f7420737570706f
72742063686172616374657220636f6465207365742e0a0063636f6e763a
2025730a0063636f6e7600636f6e7600636f6e766572742073696d706c69
666965642026207472616e646974696f6e616c204368696e6573652e0001
0000001c000000000000001c000000000000001c00000002000000700c00
003400000034000000e30d00000000000034000000030000000c00020014
000200000000015001000000000001610103010000000000140000000000
0000017a520001781001100c070890010000240000001c000000c0fcffff
ffffffff500100000000000000410e108602430d064983058e048f032400
000044000000e8fdffffffffffff220000000000000000410e108602430d
060000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000380e000000000000420e0000
000000004c0e000000000000560e000000000000600e0000000000006a0e
000000000000840e0000000000008e0e000000000000980e000000000000
a20e000000000000ac0e000000000000b60e000000000000c00e00000000
0000ca0e0000000000000b0f000000000000700c00000000000001000000
00000000100f000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000011212060104151003e405f5f50795f4e6f6e65537472756374005171
109013405f5f5f7374646572727000904064796c645f737475625f62696e
6465720080e0ffffffffffffffff019000000000000071203e405f507941
72675f50617273655475706c6500900071283e405f50794572725f4e6f4d
656d6f727900900071303e405f50794d656d5f4672656500900071383e40
5f50794d656d5f4d616c6c6f6300900071403e405f5079537472696e675f
46726f6d537472696e6700900071483e405f50795f496e69744d6f64756c
65345f3634009000715012405f63636f6e76009000715812405f63636f6e
765f636c6f7365009000716012405f63636f6e765f6f70656e0090007168
13405f5f5f627a65726f009000717013405f5f5f6572726f720090007178
13405f667072696e746600900071800113405f6677726974650090007188
0113405f7374726572726f720090000000015f0005000270795f63636f6e
76001c696e697463636f6e7600210300f018000300c01b000000f018d002
00000000fade0c0500000074000000030000000000000024000000010000
0000000000020000004cfade0c0000000028000000010000000600000002
0000000a6c696269636f6e762e32000000000003fade0c00000000280000
000100000006000000020000000b6c696253797374656d2e420000000003
00000000020000006400000000000000000000002f000000640000000000
0000000000003e000000660301002c74a75300000000010000002e010000
700c0000000000009b00000024010000700c000000000000010000002400
00005001000000000000010000004e010000500100000000000001000000
2e010000c00d000000000000a500000024010000c00d0000000000000100
0000240000002200000000000000010000004e0100002200000000000000
b0000000260a000090100000000000000100000064010000000000000000
0000be0000000e0a00009010000000000000cc0000000f010000c00d0000
00000000d70000000f010000700c000000000000e1000000010000fe0000
000000000000f3000000010000fe000000000000000003010000010000fe
00000000000000000f010000010000fe00000000000000001d0100000100
00fe000000000000000032010000010000fe000000000000000045010000
010000fe0000000000000000550100000100000300000000000000005e01
000001000003000000000000000067010000010000030000000000000000
720100000100000200000000000000007901000001000002000000000000
000086010000010000020000000000000000920100000100000300000000
000000009b010000010000030000000000000000a3010000010000030000
000000000000ad0100000100000300000000000000001000000011000000
120000001300000014000000150000001a0000001b0000001c0000001700
0000180000001d0000001e0000001f000000200000000000004016000000
190000001000000011000000120000001300000014000000150000001a00
00001b0000001c00000017000000180000001d0000001e0000001f000000
20002f566f6c756d65732f746d7066732f446f776e6c6f6164732f63636f
6e762d707974686f6e2d302e352e302f00707974686f6e5f63636f6e762e
63002f566f6c756d65732f746d7066732f446f776e6c6f6164732f63636f
6e762d707974686f6e2d302e352e302f6275696c642f74656d702e6d6163
6f73782d31302e382d7838365f36342d322e372f707974686f6e5f63636f
6e762e6f005f70795f63636f6e76005f696e697463636f6e76005f63636f
6e764d6574686f6473005f63636f6e764d6574686f6473005f696e697463
636f6e76005f70795f63636f6e76005f50794172675f5061727365547570
6c65005f50794572725f4e6f4d656d6f7279005f50794d656d5f46726565
005f50794d656d5f4d616c6c6f63005f5079537472696e675f46726f6d53
7472696e67005f50795f496e69744d6f64756c65345f3634005f5f50795f
4e6f6e65537472756374005f5f5f627a65726f005f5f5f6572726f72005f
5f5f73746465727270005f63636f6e76005f63636f6e765f636c6f736500
5f63636f6e765f6f70656e005f667072696e7466005f667772697465005f
7374726572726f720064796c645f737475625f62696e646572000000
'''.strip()))))

parser = ArgumentParser(prog="mp3cconv")
parser.add_argument("-f", default="utf-8")
parser.add_argument("-t", default="utf8-tw")
parser.add_argument("mp3s", nargs=REMAINDER)
args = parser.parse_args()

with NamedTemporaryFile() as tmpso:
  tmpso.write(cconvso)
  tmpso.flush()
  cconv = load_dynamic("cconv", tmpso.name)

  tags=dict(zip("TALB TIT2 TPE1 TPE2".split(), [TALB, TIT2, TPE1, TPE2]))
  for mp3 in args.mp3s:
    mp3=MP3(mp3)
    for t in tags:
      if t not in mp3:
        continue
      src = mp3[t].text[0]
      dst = unicode(cconv.conv(args.f, args.t, src.encode(args.f)), args.f)
      mp3[t] = tags[t](encoding=1, text=dst)
      logger.debug("%s, %s ==> %s", t, src, dst)
    mp3.save()
